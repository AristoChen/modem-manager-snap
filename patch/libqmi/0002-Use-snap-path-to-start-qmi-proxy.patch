From 8a5da9b915f09642c91d49f1607b2463e6674fd9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Alfonso=20S=C3=A1nchez-Beato?=
 <alfonsosanchezbeato@yahoo.es>
Date: Thu, 22 Dec 2016 18:22:22 +0100
Subject: [PATCH] Use snap path to start qmi-proxy

---
 src/libqmi-glib/qmi-device.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/libqmi-glib/qmi-device.c b/src/libqmi-glib/qmi-device.c
index 0ebf8f9..f799faf 100644
--- a/src/libqmi-glib/qmi-device.c
+++ b/src/libqmi-glib/qmi-device.c
@@ -1711,6 +1711,8 @@ create_iostream_with_socket (GTask *task)
     if (!self->priv->socket_connection) {
         gchar **argc;
         GSource *source;
+        const gchar *snap_path;
+        gchar *qmi_proxy_path;
 
         g_debug ("cannot connect to proxy: %s", error->message);
         g_clear_error (&error);
@@ -1729,8 +1731,17 @@ create_iostream_with_socket (GTask *task)
 
         g_debug ("spawning new qmi-proxy (try %u)...", ctx->spawn_retries);
 
+        qmi_proxy_path = g_malloc (PATH_MAX);
+        snap_path = g_getenv ("SNAP");
+        if (snap_path)
+            g_snprintf(qmi_proxy_path, PATH_MAX, "%s%s/qmi-proxy",
+                       snap_path, LIBEXEC_PATH);
+        else
+            g_snprintf(qmi_proxy_path, PATH_MAX, "%s/qmi-proxy",
+                       LIBEXEC_PATH);
+
         argc = g_new0 (gchar *, 2);
-        argc[0] = g_strdup (LIBEXEC_PATH "/qmi-proxy");
+        argc[0] = qmi_proxy_path;  /* Freed by g_strfreev */
         if (!g_spawn_async (NULL, /* working directory */
                             argc,
                             NULL, /* envp */
-- 
2.17.1

